
@{
    ViewBag.Title = "Lập danh sách các môn phân đợt thi";
}
<h2>@ViewBag.Title</h2>
<form id="InputForm">
    <p>
        Mã số môn học:
        <input type="text" id ="SubjectIDTextBox" /> 
        <button id ="AddSubject">Thêm</button>
    </p>
</form>
<form>
<table id="table">
    <thead>
        <tr>
            <th>MSMH</th>
            <th>Tên Môn Học</th>
            <th>Bộ Môn</th>
            <th>Khoa</th>
            <th>Nhóm</th>
            <th>SL SV</th>
            <th>Đợt</th>
            <th></th>
        </tr>
    </thead>
    <tbody>
    </tbody>
    <tfoot>
        <tr>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
        </tr>
    </tfoot>
</table>
    <p></p>
    <br />
    <button id="SummitButton" type="button">Lưu</button>
</form>

@Html.Partial("_DataTable.Lib")

<script src="@Url.Content("~/Scripts/UI/jquery.mousewheel.js")" type="text/javascript" lang="javascript" ></script>
<script type="text/javascript" charset="utf-8">
    var oTable;
	$(document).ready(function() {
	    oTable = $('#table').dataTable({
            "aoColumnDefs": [
                {
                    "bSortable": false, "aTargets": [7],
                    "fnCreatedCell": function (nTd, sData, oData, iRow, iCol) {
                        var b = $('<button>' + sData + '</button>');
                        b.button({
                            icons: {
                                primary: "ui-icon-trash" // hình cái thùng rác
                            }
                        }).click(function (e) {
                            e.preventDefault();
                            var row = $(this).parent().parent(); // this là cái nút, cha của nó là td ông của nó là tr ==> cái hàng cần xoá
                            if (row.length !== 0) {
                                oTable.fnDeleteRow(row[0]);
                            }
                        });
                        $(nTd).empty();
                        $(nTd).prepend(b).attr('align', 'center');
                    }
                },
                {
                    "bSortable": false, "aTargets": [6],
                    "fnCreatedCell": function (nTd, sData, oData, iRow, iCol) {
                        var b = $('<input type="text" id ="Group" size=2 readonly="true" value="' + sData + '" />');
                        b.spinner({
                            step: 1,
                            spin: function (event, ui) {
                                if (ui.value > 10) {
                                    $(this).spinner("value", 1);
                                    return false;
                                } else if (ui.value < 1) {
                                    $(this).spinner("value", 10);
                                    return false;
                                }
                            }
                        });
                        $(nTd).empty();
                        $(nTd).prepend(b.parent()).attr('align', 'center');
                    }
                },
            ], // không hiện nút sắp xếp!
	        @Html.Partial("_DataTable")
	    });

	    $('#AddSubject').button().click(function (e) {
	        e.preventDefault(); // không chạy sự kiện mặc định của đối tượng
	        var suID = $('#SubjectIDTextBox').val();
	        if ($('#table tbody td span#SubjectID[value="' + suID + '"]').length !== 0) {
	            alert("Dữ liệu môn học có mã số " + suID + " đã được thêm rồi!");
	            return false;
	        }
	        $.getJSON("/Services/LoadSubjectByGroupInfo", { SubjectID: suID },
                function (Data) {
                    if (Data[0].MSMH == "false") {
                        alert("Không tìm thấy môn học có mã số: " + suID);
                        return false;
                    }
                    var MSMH = '<span id="SubjectID" value=' + suID + '>' + suID + '</span>';
                    $.each(Data, function (index, itemData) {
                        var Class = '<span id="Class">' + itemData.Nhom + '</span>';
                        oTable.fnAddData([MSMH, itemData.TenMH, itemData.BoMon, itemData.Khoa, Class, itemData.SL, 1, "Xoá"]);
                    });
            });
	    });

	    $('#SummitButton').button().click(function () {
	        var sData = "";
	        oTable.$("#SubjectID").each(function (index, item) {
	            sData = sData + (sData == '' ? '' : '&') + 'SubjectID=' + $(this).text();
	        });
	        oTable.$("#Class").each(function (index, item) {
	            sData = sData + '&Class=' + $(this).text();
	        });
	        oTable.$("#Group").each(function (index, item) {
	            sData = sData + '&Group=' + $(this).spinner("value");
	        });
	        $.post("/SelectSubject/SelectSuccess", sData);
	        alert("Đã lưu xong");
	        return false; 
	    });
	} );
</script>